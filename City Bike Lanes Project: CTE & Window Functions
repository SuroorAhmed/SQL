-- ===================================== --
-- Section: CTE = Commom Table Expressions --
-- ===================================== --

-- Looking at date table that shows the safety rating of city bike lanes --

--Q1: List all of the bike lanes that have aa average safety rating of 4.0 or higher. Also show the average safety rating for each of those bike lanes and label them "Safe Lane"--
WITH safetyrating_average_CTE AS (
SELECT street, AVG(safetyrating) AS average_safetyrating
FROM CityBikeLanes
GROUP BY street
)
SELECT street,average_safetyrating, 'Safe Lane' AS 'label'
FROM safetyrating_average_CTE
WHERE average_safetyrating >=4.0
ORDER BY average_safetyrating DESC;

-- ===================================== --
-- Section: Window Functions --
-- ===================================== --
--Q1:List of all the bike lanes, both safety ratings for each lane given by the two technicians, the average safety rating for each lane, and a label with the recommendation as "Remove", "Leave As-Is", or "Improvements Needed".
SELECT street, safetyrating,
AVG(safetyrating) OVER (PARTITION BY street) AS 'Average_Safety_Rating',
CASE
    WHEN AVG(safetyrating) OVER(PARTITION BY street) >=4 THEN 'Leave-As-Is'
    WHEN AVG(safetyrating) OVER(PARTITION BY street) <=2 THEN 'Remove'
    ELSE 'Improvements Needed'
    END AS 'Recommendation'
FROM CityBikeLanes
ORDER BY Average_Safety_Rating ASC;  
